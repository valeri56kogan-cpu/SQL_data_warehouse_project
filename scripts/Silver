/* DDL - יצרתי את העמודות בשכבה של ה SILVER
ע"י העתקה של השכבה של BRONZER ושינוי השם ל SILVER */
=============================================================================
IF OBJECT_ID('silver.crm_cust_info', 'U') IS NOT NULL
    DROP TABLE silver.crm_cust_info;
GO

CREATE TABLE silver.crm_cust_info (
    cst_id              INT,
    cst_key             NVARCHAR(50),
    cst_firstname       NVARCHAR(50),
    cst_lastname        NVARCHAR(50),
    cst_marital_status  NVARCHAR(50),
    cst_gndr            NVARCHAR(50),
    cst_create_date     DATE,
    dwh_create_date DATETIME2 DEFAULT GETDATE()
);
GO

IF OBJECT_ID('silver.crm_prd_info', 'U') IS NOT NULL
    DROP TABLE silver.crm_prd_info;
GO

CREATE TABLE silver.crm_prd_info (
    prd_id       INT,
    prd_key      NVARCHAR(50),
    prd_nm       NVARCHAR(50),
    prd_cost     INT,
    prd_line     NVARCHAR(50),
    prd_start_dt DATETIME,
    prd_end_dt   DATETIME,
    dwh_create_date DATETIME2 DEFAULT GETDATE()
);
GO

IF OBJECT_ID('silver.crm_sales_details', 'U') IS NOT NULL
    DROP TABLE silver.crm_sales_details;
GO

CREATE TABLE silver.crm_sales_details (
    sls_ord_num  NVARCHAR(50),
    sls_prd_key  NVARCHAR(50),
    sls_cust_id  INT,
    sls_order_dt INT,
    sls_ship_dt  INT,
    sls_due_dt   INT,
    sls_sales    INT,
    sls_quantity INT,
    sls_price    INT,
    dwh_create_date DATETIME2 DEFAULT GETDATE()
);
GO

IF OBJECT_ID('silver.erp_loc_a101', 'U') IS NOT NULL
    DROP TABLE silver.erp_loc_a101;
GO

CREATE TABLE silver.erp_loc_a101 (
    cid    NVARCHAR(50),
    cntry  NVARCHAR(50),
    dwh_create_date DATETIME2 DEFAULT GETDATE()
);
GO

IF OBJECT_ID('silver.erp_cust_az12', 'U') IS NOT NULL
    DROP TABLE silver.erp_cust_az12;
GO

CREATE TABLE silver.erp_cust_az12 (
    cid    NVARCHAR(50),
    bdate  DATE,
    gen    NVARCHAR(50),
    dwh_create_date DATETIME2 DEFAULT GETDATE()
);
GO

IF OBJECT_ID('silver.erp_px_cat_g1v2', 'U') IS NOT NULL
    DROP TABLE silver.erp_px_cat_g1v2;
GO

CREATE TABLE silver.erp_px_cat_g1v2 (
    id           NVARCHAR(50),
    cat          NVARCHAR(50),
    subcat       NVARCHAR(50),
    maintenance  NVARCHAR(50),
    dwh_create_date DATETIME2 DEFAULT GETDATE()
);
GO

=============================================================================
שכבת הSILVER זאת בעצם השכבה שאנחנו רותים להכניס את הDATA הנקי שלנו כמה שיותר מסודר בלי רווחים בלי כפילויות לכן אנחנו מבצעים פה בדיקה על הDATA ורק אחרי זה טוענים אותו לשכבה הכסופה

--check 
select 
cst_id,
count(*)
from silver.crm_cust_info
group by cst_id
having count(*) >1 or cst_id is null

--check for unwanted spaces
select prd_nm
from bronzer.crm_prd_info
where prd_nm != TRIM(prd_nm)

--check for nulls or negative numbers
select prd_cost
from bronzer.crm_prd_info
where prd_cost <0 or prd_cost is null

=============================================================================
/*
ארחי שבדקנו וסידרנו את הדאטה טוב יותר נטען אותו מ BRONZER TO SILVER

 SILVER.crm_cust_info ל BRONZER.crm_cust_infoפה טענתי את 
לשים לב שהשורות מסודורת באותו הסדר כמו שטענתי את העמודות
*/
insert into silver.crm_cust_info( 
	cst_id,
	cst_key,
	cst_firstname,
	cst_lastname,
	cst_marital_status,
	cst_gndr,
	cst_create_date)

SELECT 
cst_id,
cst_key,
TRIM(cst_firstname) as cst_firstname,
TRIM(cst_lastname) as cst_lastname,
case when TRIM(cst_marital_status) = 'S' then 'Single'
	when TRIM(cst_marital_status) = 'M' then 'Married'
	else 'n/a'
end cst_marital_status, --normalize martial status value to readable format
case when TRIM(cst_gndr) = 'F' then 'Female'
	when TRIM(cst_gndr) = 'M' then 'Male'
	else 'n/a'
end cst_gndr, --normalize gndr value to readable format
cst_create_date

from (
select *,
row_number() over(partition by cst_id order by cst_create_date DESC) as flag_last
from bronzer.crm_cust_info
)t
where flag_last = 1 --select the most recent record per customer
=============================================================================
/* 
פה טענתי את  SILVER.crm_prd_info ל BRONZER.crm_prd_info 
הייתי צריכה למחוק את העמודות הקודמות ולהכניס עמודה חדשה בגלל זה יש פה את היצירה של העודמות מחדש
ואחרי זה טענתי את כל הדאטה לבפנים
*/

IF OBJECT_ID('silver.crm_prd_info', 'U') IS NOT NULL
    DROP TABLE silver.crm_prd_info;
CREATE TABLE silver.crm_prd_info (
    prd_id       INT,
    cat_id       NVARCHAR(50),
    prd_key      NVARCHAR(50),
    prd_nm       NVARCHAR(50),
    prd_cost     INT,
    prd_line     NVARCHAR(50),
    prd_start_dt DATE,
    prd_end_dt   DATE,
    dwh_create_date DATETIME2 DEFAULT GETDATE()
);

INSERT INTO silver.crm_prd_info(
    prd_id,
    cat_id,
    prd_key,
    prd_nm,
    prd_cost,
    prd_line,
    prd_start_dt,
    prd_end_dt)

select 
prd_id,
REPLACE(SUBSTRING(prd_key,1, 5),'-','_') as cat_id, --extract category ID
SUBSTRING(prd_key,7,len(prd_key)) as prd_key, --extract product key
prd_nm,
ISNULL(prd_cost,0) AS prd_cost,
CASE WHEN UPPER(TRIM(prd_line)) = 'M' THEN 'Mountain'
	WHEN UPPER(TRIM(prd_line)) = 'R' THEN 'Road'
	WHEN UPPER(TRIM(prd_line)) = 'S' THEN 'other Sales'
	WHEN UPPER(TRIM(prd_line)) = 'T' THEN 'Touring'
	else 'n/a' 
END AS prd_line, --map product line codes to descriptive ca;ues
CAST (prd_start_dt AS DATE) AS prd_start_dt,
CAST(LEAD(prd_start_dt) OVER (PARTITION BY prd_key ORDER BY prd_start_dt)-1 AS DATE) AS prd_end_dt --calculate end date as one day before the next start date
from bronzer.crm_prd_info

select * from silver.crm_prd_info
